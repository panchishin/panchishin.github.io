<html>
<title>Flying Aces - Retro</title>

<style>
body {
    background-color: hsl(0,0%,60%);
    margin: 0px;
}
canvas {
    background-color: hsl(0,100%,100%);
    z-index: 0;
}
#infobox {
    position: fixed;
    top: 0;
    right: 2em;
    z-index: 1;
    color: rgba(0,0,0,40%);
}
li {
    list-style: none;
}
</style>


<script>

var canvas = null;
var context = null;
var infobox = null;
var infoboxLastUpdate = 0;
var attitude = 0;
var power = 0;

var flakes = [];
var MAX_FLAKES = 50;
var MSEC_BETWEEN_FLAKES = 100;
var nextFlake = Date.now()
var lastUpdate = Date.now()
var groundsky = false;


function initdrawit() {
    canvas = canvas || document.getElementById("canvas");
    context = context || canvas.getContext('2d');
    infobox = infobox || document.getElementById("infobox");
    context.canvas.addEventListener("mousemove",mouseListener);
    reshapeit();
    window.requestAnimationFrame(drawit);
}

function reshapeit() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    groundsky = false;
}

function drawPlane() {
    context.save()
    context.translate(power + 10, 2*canvas.height/3);
    context.rotate(2*Math.PI*attitude/360);
    context.fillStyle = "hsl(0,80%,80%)";
    context.fillRect( -30,-5,60,10);
    context.restore();
}

function drawit() {
    var now = Date.now();
    var deltatime = now - lastUpdate;
    lastUpdate = now;

    context.clearRect(0, 0, canvas.width, canvas.height);

    groundsky = groundsky || context.createLinearGradient(0,0,0,canvas.height);
    groundsky.addColorStop(0,"white");
    groundsky.addColorStop(0.6,"blue");
    groundsky.addColorStop(0.6,"green");
    groundsky.addColorStop(0.95,"green");
    groundsky.addColorStop(0.95,"black");
    context.fillStyle = groundsky;
    context.fillRect(0,0,canvas.width,canvas.height);


    flakes = flakes.filter(function(flake){
        context.save()
        context.translate(flake.x,flake.y);
        context.rotate(flake.y/10);
        context.fillStyle = "hsla(0, "+(flake.s*10)+"%, 100%, "+(flake.s*5)+"%)";
        context.fillRect( -flake.s/2 , -flake.s/2 , flake.s , flake.s);
        context.restore()
        flake.y += deltatime * 0.01 * flake.s;
        flake.x -= deltatime * 0.001 * power;
        return flake.y + ( 7 - flake.s )*30 < canvas.height        
    });


    if (Date.now() > nextFlake && flakes.length <= MAX_FLAKES) {
        nextFlake += MSEC_BETWEEN_FLAKES;
        flakes.push({
            x : Math.random() * canvas.width * 2 ,
            y : 0 , 
            s : Math.random() * 7 + 1
        })
    }

    drawPlane();

    if (Date.now() > infoboxLastUpdate + 200) {
        infobox.innerHTML = "<li>Attitude = " + attitude + "</li>"+
            "<li>Power = " + power + "%</li>" +
            "<li>Flakes = " + flakes.length + "</li>";
        infoboxLastUpdate = Date.now();
    }
    window.requestAnimationFrame(drawit);
}

function mouseListener(event) {
    power = Math.round(100*event.offsetX / canvas.width);
    attitude = Math.round(90 * event.offsetY / canvas.height - 45);
}


window.onload = initdrawit;
window.onresize = reshapeit;

</script>


<body>
    <canvas id="canvas" width="800" height="400">no canvas? no game</canvas>
    <ul id="infobox"><li>Some info here<li></ul>
</body>

</html>