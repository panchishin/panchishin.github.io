<html>
<title>Flying Ace - Retro</title>

<style>
body {
    background-color: hsl(0,0%,60%);
    margin: 0px;
}
canvas {
    z-index: 0;
}
#infobox {
    position: fixed;
    top: 0;
    right: 2em;
    z-index: 1;
    color: rgba(0,0,0,40%);
}
#front {
    position: fixed;
    height: 50%;
    width: 50%;
    z-index: 1;
}
#front #message {
    position: absolute;
    text-align: center;
    height: 10em;
    bottom: -5em;
    width: 10em;
    right: -5em;
    color: rgb(0,0,0,80%);
}
li {
    list-style: none;
}
</style>


<script>

var canvas = null;
var context = null;
var infobox = null;
var infoboxLastUpdate = 0;
var attitude = 0;
var power = 50;
var height = 50;


var flakes = [];
var MAX_FLAKES = 50;
var MSEC_BETWEEN_FLAKES = 100;
var nextFlake = Date.now()
var lastUpdate = Date.now()
var groundsky = false;


function clickToStart() {
    document.getElementById("message").innerHTML = "";
    document.getElementById("front").style.display = "none";

    canvas = canvas || document.getElementById("canvas");
    context = context || canvas.getContext('2d');
    infobox = infobox || document.getElementById("infobox");

    window.onresize = reshapeit;
    reshapeit();
    window.addEventListener("mousemove",planeControl);
    window.requestAnimationFrame(drawit);
}

function reshapeit() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    groundsky = false;
}

function drawPlane(deltatime) {
    context.save()
    height += attitude*power*deltatime/50000;
    height = Math.max(0,Math.min(100,height));
    context.translate(power + 10, canvas.height*height/100);
    context.rotate(2*Math.PI*attitude/360);
    context.fillStyle = "hsl(0,80%,80%)";
    context.fillRect( -30,-5,60,10);
    context.restore();
}

function drawit() {
    var now = Date.now();
    var deltatime = now - lastUpdate;
    lastUpdate = now;

    context.clearRect(0, 0, canvas.width, canvas.height);

    groundsky = groundsky || context.createLinearGradient(0,0,0,canvas.height);
    groundsky.addColorStop(0,"white");
    groundsky.addColorStop(0.6,"blue");
    groundsky.addColorStop(0.6,"green");
    groundsky.addColorStop(0.95,"green");
    groundsky.addColorStop(0.95,"black");
    context.fillStyle = groundsky;
    context.fillRect(0,0,canvas.width,canvas.height);


    flakes = flakes.filter(function(flake){
        context.save()
        context.translate(flake.x,flake.y);
        context.rotate(flake.y/10);
        context.fillStyle = "hsla(0, "+(flake.s*10)+"%, 100%, "+(flake.s*5)+"%)";
        context.fillRect( -flake.s/2 , -flake.s/2 , flake.s , flake.s);
        context.restore()
        flake.y += deltatime * 0.01 * flake.s;
        flake.x -= deltatime * 0.001 * power;
        return flake.y + ( 7 - flake.s )*30 < canvas.height        
    });


    if (Date.now() > nextFlake && flakes.length < MAX_FLAKES) {
        nextFlake += MSEC_BETWEEN_FLAKES;
        flakes.push({
            x : Math.random() * canvas.width * 2 ,
            y : 0 , 
            s : Math.random() * 7 + 1
        })
    }

    drawPlane(deltatime);

    if (Date.now() > infoboxLastUpdate + 200) {
        infobox.innerHTML = "<li>Attitude = " + attitude + "</li>"+
            "<li>Power = " + power + "%</li>" +
            "<li>Flakes = " + flakes.length + "</li>" +
            "<li>Height = " + Math.round(height) + "</li>";
        infoboxLastUpdate = Date.now();
    }
    window.requestAnimationFrame(drawit);
}

function planeControl(event) {
    if (event && canvas) {
        var previousPower = power
        power = Math.round(100*event.pageX / canvas.width);
        attitude = Math.round(90 * event.pageY / canvas.height - 45);
    }
}

</script>


<body>
    <div id="front"><div id='message' onclick="clickToStart()"><h1>Flying Ace</h1><h2>Click to start</h2></div></div>
    <canvas id="canvas" width="800" height="400">no canvas? no game</canvas>
    <ul id="infobox"></ul>
</body>

</html>