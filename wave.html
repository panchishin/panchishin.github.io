<!DOCTYPE html>
<html>
<body>

<canvas id="myCanvas" width="500" height="300" style="border:1px solid #d3d3d3;">
Your browser does not support the HTML5 canvas tag.</canvas>
<p>FPS = <span id=fps>60</span></p>
<button onclick="resetAll();">Reset</button>
<script>

var fpsElement = document.getElementById("fps");

var fps = 60;
var fpsLambda = 0.04;

var visibleCanvas = document.getElementById("myCanvas");
var visibleCtx = visibleCanvas.getContext('2d');

var terrainCanvas = document.createElement('canvas');
terrainCanvas.width  = 600;
terrainCanvas.height = 300;
var terrainCtx = terrainCanvas.getContext("2d");

function Terrain(color, height, change) {
    return {
        color : color,
        height : height,
        change : change,
        points : [],
        create : function createTerrain() {
            this.points = [ ];
            var height = this.height;
            for( var offset = -20 ; offset < 600 ; offset += 20 ) {
              height += Math.random() * this.change * 2 - this.change;
              this.points.push( [ offset , height ] )
            }
            return this;
        },
        move : function moveTerrain() {
            this.points.shift();
            this.points.forEach(function(point) {
                point[0] -= 20;
            })
            var last = this.points[this.points.length-1];
            this.points.push( [last[0]+20 , last[1] += Math.random()* this.change * 2 - this.change ])
        },
        paint : function paintTerrain() {
            terrainCtx.fillStyle = this.color;
            terrainCtx.beginPath();
            terrainCtx.moveTo(this.points[0][0],300);
            for(var index = 0 ; index < this.points.length ; index++) {
                terrainCtx.lineTo(this.points[index][0],this.points[index][1])
            }
            terrainCtx.lineTo(this.points[this.points.length-1][0],300)
            terrainCtx.closePath();
            terrainCtx.fill();

            terrainCtx.strokeStyle = this.color;
            terrainCtx.lineWidth = 10;
            terrainCtx.beginPath();

            terrainCtx.moveTo(this.points[0][0], this.points[0][1]);

            for (i = 1; i < this.points.length - 2; i ++)
            {
              var xc = (this.points[i][0] + this.points[i + 1][0]) / 2;
              var yc = (this.points[i][1] + this.points[i + 1][1]) / 2;
              terrainCtx.quadraticCurveTo(this.points[i][0], this.points[i][1], xc, yc);
            }
            // curve through the last two this.points
            terrainCtx.quadraticCurveTo(this.points[i][0], this.points[i][1], this.points[i+1][0],this.points[i+1][1]);
             
            terrainCtx.stroke();
            return this.points;
        }
    }
}

var terrains = [];

var l1,l2,l3,l4,l5;
var offset = 0;
function resetAll() {
    terrains = [
        Terrain("white",100,20).create(),
        Terrain("green",100,5).create(),
        Terrain("brown",150,15).create(),
        Terrain("grey",200,20).create(),
        Terrain("black",250,5).create(),
    ];
    offset = 0;
}
resetAll();

var previousTime = Date.now();

var theData = null;

function paintAll(invokeTime) {
    terrainCtx.clearRect(0, 0, terrainCanvas.width, terrainCanvas.height);
    terrains.forEach(function(terrain) {
        terrain.paint()
    })

    visibleCtx.clearRect(0, 0, visibleCanvas.width, visibleCanvas.height);
    visibleCtx.fillStyle = "blue";
    visibleCtx.fillRect(0,0,800,300);
    //call its drawImage() function passing it the source terrainCanvas directly
    visibleCtx.drawImage(terrainCanvas, -offset, 0);


    var instantFps = 1000/Math.max(10,invokeTime - previousTime);
    previousTime = invokeTime;
    fps = fps * (1 - fpsLambda) + instantFps * fpsLambda

    offset += 1;
    if (offset >= 20) {
        offset -= 20;
        terrains.forEach(function(terrain) {
            terrain.move()
        })
        fpsElement.innerHTML = Math.round(fps)
    }

    window.requestAnimationFrame(paintAll)

}

window.requestAnimationFrame(paintAll)

</script> 

</body>
</html>
